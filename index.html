<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSPO中文精華收集器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> body { background-color: #111827; } </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="app"></div>

    <script type="module">
        // --- 全域變數與狀態管理 ---
        const PROXY_ENDPOINT = 'https://vvspo-proxy-git-main-renas-projects-c8ce958b.vercel.app'; 

        let state = {
            allVideos: [], isLoading: true, lastUpdated: null,
            apiError: null,
        };

        const appContainer = document.getElementById('app');
        
        // --- UI 元件產生器 ---
        function createSpinner() {
            const container = document.createElement('div');
            container.className = "flex flex-col items-center justify-center space-y-4 p-8";
            container.innerHTML = `<div class="w-16 h-16 border-4 border-blue-400 border-t-transparent border-solid rounded-full animate-spin"></div><p class="text-lg text-gray-300">正在獲取 VSPO 精華... ✨</p>`;
            return container;
        }
        function createErrorDisplay(error) {
            const container = document.createElement('div');
            let errorMessage = error;
            let errorHint = "請檢查代理伺服器是否正常運作，或稍後再試。";
            
            if (error && error.toLowerCase().includes('quota')) {
                 errorMessage = "API 每日配額已用盡";
                 errorHint = "請等待台灣時間下午 4 點後，配額將會自動重置。";
            }

            container.className = "bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-center";
            container.innerHTML = `<strong class="font-bold">發生錯誤！</strong><p class="block sm:inline ml-2">${errorMessage}</p><p class="mt-2 text-sm">${errorHint}</p>`;
            return container;
        }
        function createVideoCard(video, showChannel = true) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}萬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { '年': 31536000, '個月': 2592000, '天': 86400, '小時': 3600, '分鐘': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}前`;
                }
                return "剛剛";
            };
            const card = document.createElement('div');
            card.className = "bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-cyan-400/30 transition-shadow duration-300 flex flex-col";
            const channelLink = showChannel ? `<a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer"><p class="text-sm text-gray-400 mt-2 hover:text-white transition-colors">${video.channelTitle}</p></a>` : '';
            card.innerHTML = `
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
                </a>
                <div class="p-4 flex flex-col flex-grow">
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                    </a>
                    ${channelLink}
                    <div class="flex justify-between items-center text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700">
                        <span>${formatNumber(video.viewCount)} 次觀看</span>
                        <span>${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>`;
            return card;
        }
        
        // --- API 請求邏輯 (已大幅簡化) ---
        async function fetchAllDataFromProxy() {
            console.log("向代理伺服器發送單一請求...");
            const url = new URL(`${PROXY_ENDPOINT}/api/youtube`);
            const response = await fetch(url);
            
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `Request failed with status ${response.status}`);
            }
            console.log("成功從代理獲取資料！");
            return data;
        }

        // --- 主應用程式邏輯與渲染 ---
        function render() {
            const { allVideos, isLoading, lastUpdated, apiError } = state;
            
            const recentVideos = allVideos.slice(0, 10);
            const channels = {};
            allVideos.forEach(video => {
                if (!channels[video.channelId]) {
                    channels[video.channelId] = {
                        id: video.channelId, name: video.channelTitle,
                        subscriberCount: video.subscriberCount, latestVideo: video,
                    };
                }
            });
            const channelData = Object.values(channels).sort((a,b) => b.subscriberCount - a.subscriberCount);
            
            appContainer.innerHTML = '';
            const mainContainer = document.createElement('div');
            mainContainer.className = "container mx-auto px-4 py-8";
            
            let contentHtml;
             if (isLoading) {
                contentHtml = createSpinner().outerHTML;
            } else if (apiError) {
                contentHtml = createErrorDisplay(apiError).outerHTML;
            } else if (allVideos.length === 0) {
                 contentHtml = `<p class="text-center text-gray-400 p-8">找不到符合條件的影片，或代理伺服器的快取尚未建立。</p>`;
            } else {
                const recentVideosSection = document.createElement('section');
                const recentVideosGrid = document.createElement('div');
                recentVideosGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6';
                recentVideos.forEach(video => recentVideosGrid.appendChild(createVideoCard(video)));
                recentVideosSection.innerHTML = `<h2 class="text-3xl font-bold mb-6 border-l-4 border-cyan-400 pl-4">最新精華影片</h2>`;
                recentVideosSection.appendChild(recentVideosGrid);

                const channelListSection = document.createElement('section');
                const channelListContainer = document.createElement('div');
                channelListContainer.className = 'space-y-6';
                channelData.forEach(channel => {
                    const channelCard = document.createElement('div');
                    const formatNumber = (num) => num >= 10000 ? `${(num / 10000).toFixed(1)}萬` : num.toLocaleString();
                    channelCard.className = "bg-gray-800 p-4 rounded-lg flex flex-col md:flex-row items-start gap-4 shadow-lg hover:shadow-purple-400/30 transition-shadow duration-300";
                    channelCard.innerHTML = `
                        <div class="w-full md:w-1/3 lg:w-1/4 flex-shrink-0">
                            <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer" class="block mb-2">
                                <h3 class="text-xl font-bold hover:text-purple-400 transition-colors">${channel.name}</h3>
                            </a>
                            <p class="text-gray-400">${formatNumber(channel.subscriberCount)} 位訂閱者</p>
                        </div>`;
                    const videoWrapper = document.createElement('div');
                    videoWrapper.className = 'w-full md:w-2/3 lg:w-3/4';
                    videoWrapper.innerHTML = `<p class="text-sm text-gray-400 mb-2">最新影片:</p>`;
                    videoWrapper.appendChild(createVideoCard(channel.latestVideo, false));
                    channelCard.appendChild(videoWrapper);
                    channelListContainer.appendChild(channelCard);
                });
                channelListSection.innerHTML = `<h2 class="text-3xl font-bold mb-6 border-l-4 border-cyan-400 pl-4 mt-12">精華頻道列表</h2>`;
                channelListSection.appendChild(channelListContainer);
                
                contentHtml = recentVideosSection.outerHTML + channelListSection.outerHTML;
            }

            mainContainer.innerHTML = `
                <header class="text-center mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-cyan-400">VSPO中文精華收集器</h1>
                </header>
                <div class="sticky top-0 z-10 bg-gray-900/80 backdrop-blur-sm py-4 mb-8">
                    <div class="text-center text-sm text-gray-500 mt-3 flex justify-center items-center space-x-4 flex-wrap">
                        ${lastUpdated ? `<span class="whitespace-nowrap">資料時間: ${lastUpdated.toLocaleTimeString()}</span>` : ''}
                    </div>
                </div>
                <div>${contentHtml}</div>
            `;
            appContainer.appendChild(mainContainer);
        }

        async function initializeApp() {
            state.isLoading = true;
            render();
            try {
                const videos = await fetchAllDataFromProxy();
                state.allVideos = videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                state.lastUpdated = new Date(); // 使用當前時間作為資料時間戳
            } catch (error) {
                console.error("初始化失敗:", error);
                state.apiError = error.message;
            } finally {
                state.isLoading = false;
                render();
            }
        }

        initializeApp();

    </script>
</body>
</html>
