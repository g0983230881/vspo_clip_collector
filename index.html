<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>れなち的VSPO中文精華收集處</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> 
        body { background-color: #111827; } 
        /* Tooltip 樣式 */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937; /* gray-800 */
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 10;
            bottom: 150%;
            left: 50%;
            margin-left: -140px; /* Use half of the width to center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #4b5563; /* gray-600 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        /* 在 hover 或 focus-within (適用於鍵盤和觸控) 時顯示 */
        .tooltip:hover .tooltiptext,
        .tooltip:focus-within .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .secret-trigger {
            cursor: pointer;
        }
        /* 分頁與頁籤按鈕樣式 */
        .tab-btn {
            padding: 0.5rem 1rem; border-radius: 0.375rem;
            background-color: #374151; color: #d1d5db;
            transition: background-color 0.2s;
        }
        .tab-btn.active, .tab-btn:hover {
            background-color: #4f46e5; color: #fff;
        }
        .pagination-btn {
            min-width: 2.5rem; /* 確保按鈕有最小寬度 */
            padding: 0.5rem; 
            border: 1px solid #4b5563;
            background-color: #374151; color: #d1d5db;
            border-radius: 0.375rem; transition: background-color 0.2s;
            text-align: center;
        }
        .pagination-btn:hover:not(:disabled) {
            background-color: #4f46e5;
        }
        .pagination-btn.active {
            background-color: #4f46e5; color: #fff; border-color: #4f46e5;
        }
        .pagination-btn:disabled {
            opacity: 0.5; cursor: not-allowed;
        }
        .pagination-ellipsis {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 2.5rem;
            padding: 0.5rem;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="app"></div>

    <script type="module">
        // --- 全域變數與狀態管理 ---
        const PROXY_ENDPOINT = 'https://vspo-proxy-git-main-renas-projects-c8ce958b.vercel.app'; 

        let state = {
            allVideos: [], 
            isLoading: true, 
            lastUpdated: null, 
            apiError: null,
            totalVisits: 0,
            todayVisits: 0,
            activeView: 'latest', // 'latest' 或 'all'
            currentPage: 1,
            itemsPerPage: 10,
        };

        const appContainer = document.getElementById('app');
        
        // --- UI 元件產生器 ---
        function createErrorDisplay(error) {
            const container = document.createElement('div');
            let errorMessage = error;
            let errorHint = "請檢查代理伺服器是否正常運作，或稍後再試。";
            
            if (error && error.toLowerCase().includes('quota')) {
                 errorMessage = "API 每日配額已用盡";
                 errorHint = "請等待台灣時間下午 4 點後，配額將會自動重置。";
            }

            container.className = "bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-center";
            container.innerHTML = `<strong class="font-bold">發生錯誤！</strong><p class="block sm:inline ml-2">${errorMessage}</p><p class="mt-2 text-sm">${errorHint}</p>`;
            return container;
        }
        function createVideoCard(video, showChannel = true) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}萬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { '年': 31536000, '個月': 2592000, '天': 86400, '小時': 3600, '分鐘': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}前`;
                }
                return "剛剛";
            };
            const card = document.createElement('div');
            card.className = "group bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-cyan-400/30 transition-shadow duration-300 flex flex-col";
            
            const channelLink = showChannel ? `
                <a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-2">
                    <img src="${video.channelAvatarUrl}" class="w-6 h-6 rounded-full bg-gray-700">
                    <p class="text-sm text-gray-400 hover:text-white transition-colors truncate">${video.channelTitle}</p>
                </a>` : '';

            card.innerHTML = `
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="block w-full aspect-video bg-gray-700 overflow-hidden">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
                </a>
                <div class="p-4 flex flex-col flex-grow">
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                    </a>
                    ${channelLink}
                    <div class="flex justify-between items-center text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700">
                        <span>${formatNumber(video.viewCount)} 次觀看</span>
                        <span>${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>`;
            return card;
        }
        
        function createVideoListItem(video) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}萬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { '年': 31536000, '個月': 2592000, '天': 86400, '小時': 3600, '分鐘': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}前`;
                }
                return "剛剛";
            };
            const item = document.createElement('div');
            item.className = "flex items-center space-x-4 p-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors duration-200";
            item.innerHTML = `
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 w-32 aspect-video bg-gray-700 rounded-md overflow-hidden">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/128x72/1a202c/e53e3e?text=Error';">
                </a>
                <div class="flex-1 min-w-0">
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer">
                        <h3 class="font-semibold text-gray-100 truncate hover:text-cyan-400">${video.title}</h3>
                    </a>
                    <a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-1">
                        <img src="${video.channelAvatarUrl}" class="w-5 h-5 rounded-full bg-gray-700">
                        <p class="text-sm text-gray-400 hover:text-white truncate">${video.channelTitle}</p>
                    </a>
                    <div class="flex justify-between items-center text-xs text-gray-500 mt-2">
                        <span>${formatNumber(video.viewCount)} 次觀看</span>
                        <span>${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>
            `;
            return item;
        }

        function createChannelGridCard(channel) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}萬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { '年': 31536000, '個月': 2592000, '天': 86400, '小時': 3600, '分鐘': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}前`;
                }
                return "剛剛";
            };

            const card = document.createElement('div');
            card.className = "group bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-purple-400/30 transition-shadow duration-300 flex flex-col";
            
            const video = channel.latestVideo;

            card.innerHTML = `
                <div class="p-4">
                    <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-3">
                        <img src="${channel.avatarUrl}" alt="${channel.name}" class="w-12 h-12 rounded-full bg-gray-700 flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-bold text-purple-300 truncate">${channel.name}</p>
                            <p class="text-sm text-gray-400">${formatNumber(channel.subscriberCount)} 位訂閱者</p>
                        </div>
                    </a>
                </div>
                <div class="px-4 text-sm text-gray-400">最新影片:</div>
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="block w-full aspect-video bg-gray-700 overflow-hidden mt-2">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
                </a>
                <div class="p-4 flex flex-col flex-grow">
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                    </a>
                    <div class="flex justify-between items-center text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700">
                        <span>${formatNumber(video.viewCount)} 次觀看</span>
                        <span>${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>
            `;
            return card;
        }
        
        function createSkeleton(type) {
            const skeleton = document.createElement('div');
            if (type === 'card') {
                skeleton.className = "bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col";
                skeleton.innerHTML = `<div class="w-full aspect-video bg-gray-700 animate-pulse"></div><div class="p-4"><div class="h-4 bg-gray-700 rounded w-3/4 mb-4 animate-pulse"></div><div class="h-4 bg-gray-700 rounded w-1/2 animate-pulse"></div></div>`;
            } else if (type === 'list') {
                skeleton.className = "flex items-center space-x-4 p-3 bg-gray-800 rounded-lg animate-pulse";
                skeleton.innerHTML = `<div class="w-32 h-[72px] bg-gray-700 rounded-md"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-700 rounded w-5/6"></div><div class="h-4 bg-gray-700 rounded w-1/3"></div><div class="h-3 bg-gray-700 rounded w-1/2"></div></div>`;
            }
            return skeleton;
        }

        // --- API 請求邏輯 ---
        async function fetchAllDataFromProxy(force = false, password = '') {
            console.log(`向代理伺服器發送請求... 強制更新: ${force}`);
            const url = new URL(`${PROXY_ENDPOINT}/api/youtube`);
            if (force) {
                url.searchParams.append('force_refresh', 'true');
                url.searchParams.append('password', password);
            }
            const response = await fetch(url);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Request failed with status ${response.status}`);
            console.log("成功從代理獲取資料！");
            return data;
        }
        
        function createPaginationControls(totalPages, currentPage) {
            const container = document.createElement('div');
            container.className = 'flex justify-center items-center space-x-1 md:space-x-2 mt-8';

            const createBtn = (text, page, isDisabled = false, isActive = false) => {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${isActive ? 'active' : ''}`;
                btn.textContent = text;
                btn.dataset.page = page;
                if (isDisabled) btn.disabled = true;
                return btn;
            };

            const createEllipsis = () => {
                const span = document.createElement('span');
                span.className = 'pagination-ellipsis';
                span.textContent = '...';
                return span;
            };

            container.appendChild(createBtn('‹', currentPage - 1, currentPage === 1));

            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    container.appendChild(createBtn(i, i, false, i === currentPage));
                }
            } else {
                const pages = new Set();
                pages.add(1);
                pages.add(totalPages);
                pages.add(currentPage);
                if (currentPage > 1) pages.add(currentPage - 1);
                if (currentPage < totalPages) pages.add(currentPage + 1);

                const sortedPages = Array.from(pages).sort((a, b) => a - b);
                let lastPage = 0;

                for (const page of sortedPages) {
                    if (lastPage !== 0 && page - lastPage > 1) {
                        container.appendChild(createEllipsis());
                    }
                    container.appendChild(createBtn(page, page, false, page === currentPage));
                    lastPage = page;
                }
            }

            container.appendChild(createBtn('›', currentPage + 1, currentPage === totalPages));

            return container;
        }

        // --- 主應用程式邏輯與渲染 ---
        function render() {
            const { allVideos, isLoading, lastUpdated, apiError, totalVisits, todayVisits, activeView, currentPage, itemsPerPage } = state;
            
            appContainer.innerHTML = '';
            const mainContainer = document.createElement('div');
            mainContainer.className = "container mx-auto px-4 py-8";
            
            let contentHtml;
            if (isLoading) {
                const videoSkeletons = Array.from({ length: 10 }).map(() => createSkeleton('card').outerHTML).join('');
                contentHtml = `<section style="min-height: 720px;"><div class="flex items-center justify-between mb-6"><div class="h-8 bg-gray-700 rounded w-1/3 animate-pulse"></div><div class="h-8 bg-gray-700 rounded w-1/4 animate-pulse"></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">${videoSkeletons}</div></section>`;
            } else if (apiError) {
                contentHtml = createErrorDisplay(apiError).outerHTML;
            } else if (allVideos.length === 0) {
                 contentHtml = `<p class="text-center text-gray-400 p-8">找不到符合條件的影片，或代理伺服器的快取尚未建立。</p>`;
            } else {
                // --- 影片區塊渲染 ---
                const videosSection = document.createElement('section');
                const videosHeader = document.createElement('div');
                videosHeader.className = "flex items-center justify-between mb-6";
                videosHeader.innerHTML = `
                    <div class="flex items-center">
                        <h2 class="text-3xl font-bold border-l-4 border-cyan-400 pl-4">精華影片</h2>
                        <div class="tooltip ml-2">
                            <button class="text-sm bg-gray-600 text-gray-300 rounded-full w-5 h-5 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-cyan-400" aria-label="說明">?</button>
                            <div class="tooltiptext">
                                <p class="font-semibold mb-2">說明：</p>
                                <p>1. 伺服器快取每 30 分鐘更新一次。</p>
                                <p>2. 為關鍵字搜尋，故可能出現：</p>
                                <p class="pl-4">a. 含VSPO關鍵字的非VSPO烤肉</p>
                                <p class="pl-4">b. 含中文關鍵字的外文剪輯</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="view-latest-btn" class="tab-btn ${activeView === 'latest' ? 'active' : ''}">最新十部</button>
                        <button id="view-all-btn" class="tab-btn ${activeView === 'all' ? 'active' : ''}">一個月內</button>
                    </div>
                `;
                videosSection.appendChild(videosHeader);

                const viewContainer = document.createElement('div');
                viewContainer.style.minHeight = '720px'; 
                
                if (activeView === 'latest') {
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6';
                    allVideos.slice(0, 10).forEach(video => grid.appendChild(createVideoCard(video)));
                    viewContainer.appendChild(grid);
                } else { // activeView === 'all'
                    const listContainer = document.createElement('div');
                    listContainer.className = 'space-y-3';
                    const totalPages = Math.ceil(allVideos.length / itemsPerPage);
                    const startIndex = (currentPage - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedVideos = allVideos.slice(startIndex, endIndex);
                    
                    paginatedVideos.forEach(video => listContainer.appendChild(createVideoListItem(video)));
                    viewContainer.appendChild(listContainer);

                    const paginationControls = createPaginationControls(totalPages, currentPage);
                    viewContainer.appendChild(paginationControls);
                }
                videosSection.appendChild(viewContainer);
                
                // --- 頻道列表區塊渲染 ---
                const channels = {};
                allVideos.forEach(video => {
                    if (!channels[video.channelId]) {
                        channels[video.channelId] = {
                            id: video.channelId, name: video.channelTitle,
                            subscriberCount: video.subscriberCount, 
                            latestVideo: video, avatarUrl: video.channelAvatarUrl
                        };
                    }
                });
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const channelData = Object.values(channels)
                    .filter(channel => new Date(channel.latestVideo.publishedAt) > thirtyDaysAgo)
                    .sort((a, b) => new Date(b.latestVideo.publishedAt) - new Date(a.latestVideo.publishedAt));

                const channelListSection = document.createElement('section');
                const channelListGrid = document.createElement('div');
                channelListGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6';
                if(channelData.length > 0) {
                    channelData.forEach(channel => channelListGrid.appendChild(createChannelGridCard(channel)));
                } else {
                     channelListGrid.innerHTML = `<p class="text-gray-400">找不到過去30天內有更新的頻道。</p>`;
                }
                channelListSection.innerHTML = `<div class="flex items-baseline mb-6 gap-x-3"><h2 class="text-3xl font-bold border-l-4 border-purple-400 pl-4 mt-12">精華頻道列表</h2><p class="text-gray-500 text-sm">僅列出30天內有發布新影片之頻道</p></div>`;
                channelListSection.appendChild(channelListGrid);
                
                contentHtml = videosSection.outerHTML + channelListSection.outerHTML;
            }

            mainContainer.innerHTML = `
                <header class="text-center mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-cyan-400">
                        <span class="secret-trigger" data-char="れ">れ</span><span class="secret-trigger" data-char="な">な</span><span class="secret-trigger" data-char="ち">ち</span>的VSPO中文精華收集處
                    </h1>
                </header>
                <div class="sticky top-0 z-10 bg-gray-900/80 backdrop-blur-sm py-4 mb-8">
                    <div class="text-center text-sm text-gray-500 mt-3 flex justify-center items-center space-x-4 flex-wrap">
                        <span class="whitespace-nowrap">👀 總人次: <span class="font-semibold text-teal-400">${totalVisits.toLocaleString()}</span></span>
                        <span class="whitespace-nowrap">☀️ 今日人次: <span class="font-semibold text-amber-400">${todayVisits.toLocaleString()}</span></span>
                        ${lastUpdated ? `<span class="whitespace-nowrap">資料時間: ${lastUpdated.toLocaleTimeString()}</span>` : ''}
                    </div>
                </div>
                <div>${contentHtml}</div>
            `;
            appContainer.appendChild(mainContainer);
            setupEventListeners();
        }

        function setupEventListeners() {
            setupSecretTrigger();
            document.getElementById('view-latest-btn')?.addEventListener('click', () => {
                state.activeView = 'latest';
                render();
            });
            document.getElementById('view-all-btn')?.addEventListener('click', () => {
                state.activeView = 'all';
                state.currentPage = 1;
                render();
            });
            document.querySelectorAll('.pagination-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const page = parseInt(e.currentTarget.dataset.page, 10);
                    if (page && page !== state.currentPage) {
                        state.currentPage = page;
                        render();
                    }
                });
            });
        }

        async function initializeApp(force = false, password = '') {
            state.isLoading = true;
            render(); 
            try {
                const dataPackage = await fetchAllDataFromProxy(force, password);
                state.allVideos = dataPackage.videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                state.lastUpdated = new Date(dataPackage.timestamp);
                state.totalVisits = dataPackage.totalVisits || 0;
                state.todayVisits = dataPackage.todayVisits || 0;
            } catch (error) {
                console.error("初始化失敗:", error);
                state.apiError = error.message;
                if (force) alert(`錯誤: ${error.message}`);
            } finally {
                state.isLoading = false;
                render();
            }
        }
        
        function setupSecretTrigger() {
            let sequence = [];
            let lastClickTime = 0;
            const targetSequence = ['れ', 'な', 'ち'];

            document.querySelectorAll('.secret-trigger').forEach(span => {
                span.addEventListener('click', (e) => {
                    const char = e.target.dataset.char;
                    const now = Date.now();
                    if (now - lastClickTime > 3000) sequence = [];
                    sequence.push(char);
                    lastClickTime = now;
                    if (sequence.join('') === targetSequence.join('')) {
                        console.log("秘密通道已觸發！");
                        const password = prompt("請輸入管理員密碼以強制更新快取：");
                        if (password) initializeApp(true, password);
                        sequence = [];
                    }
                    if (sequence.length >= targetSequence.length && sequence.join('') !== targetSequence.join('')) {
                       sequence = [];
                    }
                });
            });
        }

        initializeApp();

    </script>
</body>
</html>
